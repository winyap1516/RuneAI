# 项目架构审查报告

> 审查范围：前端认证与路由、Supabase 客户端与配置、同步与控制器、Edge Functions 安全校验、UI 入口一致性与体验
> 版本：2025-12-06

## 总览与定位
- Monarch（核心）：`js/features/dashboard.js`、`js/controllers/linkController.js`、Digest Edge Functions
- Minister（骨干）：`js/services/supabaseClient.js`、`js/services/config.js`、`js/storage/*`、`js/sync/*`
- Support（佐使）：`js/utils/*`、`js/components/*`、`tests/*`
- Envoy（外联）：页面入口与文档、OAuth 设置、Edge Functions 接口
- Five-Elements：
  - Wood：认证与仪表盘业务（`js/features/auth_ui.js`、`js/features/dashboard.js`）
  - Fire：列表渲染与滚动优化（`js/features/dashboard.js`、`tests/virtualScroll.test.js`）
  - Earth：客户端/存储/迁移/配置（`js/services/*`、`js/storage/*`、`supabase/migrations/*`）
  - Metal：安全规则与验证（RLS、邮箱确认、角色校验、`js/services/logger.js`）
  - Water：控制器与同步管线（`js/controllers/*`、`js/sync/*`、Edge Functions）

## 先修项（P0 修复）
- 路由一致性（登出与守卫统一）
  - 现状：登出回 `index.html`（`js/features/auth_ui.js:127-131`），Dashboard 守卫回 `login.html`（`js/dashboard_init.js:16-19`）
  - 建议：统一指向 `login.html`（或统一 `index.html`，二选一）。推荐登录统一入口 `login.html`。
- 授权兜底策略（生产禁用）
  - 现状：`getAuthHeaders` 在无 JWT 时回退 `anon key` 或 `localStorage`（`js/services/supabaseClient.js:93-143`）
  - 建议：生产构建禁用回退，仅 Dev 可通过显式开关启用（例如 `window.__DISABLE_AUTH_FALLBACK__ = false` 时才启用）。
- OAuth 重定向一致性
  - 现状：`auth_ui.js` 使用 `window.location.origin + '/dashboard.html'`（`js/features/auth_ui.js:269-270`），`authView.js` 使用 `config.frontendBaseUrl`（`js/views/authView.js:20`）但无页面路径
  - 建议：统一使用 `${config.frontendBaseUrl}/dashboard.html`。
- 配置校验策略
  - 现状：`config.validate()` 将 `VITE_FRONTEND_BASE_URL` 标为必需（`js/services/config.js:17-21`）
  - 建议：改为条件必需（仅当使用邮箱重置/重发/OAuth 跳转时强制），否则提示警告不阻断。

## 重构项（结构性优化）
- Supabase 客户端改为 ESM 引入
  - 现状：依赖 `window.supabase`（`js/services/supabaseClient.js:18-35`）
  - 建议：使用 `import { createClient } from '@supabase/supabase-js'`，去除对全局的依赖；减少 CDN 与环境差异问题。
- 入口一致性（Landing Modal）
  - 现状：`index.html` 准备了 Modal 容器（`index.html:170-178`）但未挂载 `public/components/modal_login.html`
  - 建议：在 `js/main.js` 按需注入登录/注册组件，调用 `initAuthUI('login'|'register')` 完成绑定；或明确停用 Modal，统一走独立页。
- 清理重复静态资源
  - 现状：`components/modal_login.html` 与 `public/components/modal_login.html` 重复
  - 建议：保留 `public/components/modal_login.html` 为唯一来源，删除根目录重复副本。

## 安全影响（Metal）
- Authorization 兜底风险：
  - 使用 `anon key` 作为 `Authorization` 会掩盖权限缺失并导致安全策略绕过风险，应在生产禁用（`js/services/supabaseClient.js:128-133`）。
- Edge Functions 校验：
  - 已存在邮箱验证与 JWT 校验（例如 `supabase/functions/generate-digest/index.ts:29-32`），建议在其他函数统一强制 `getUser(jwt)` 验证。
- 重定向安全：
  - `resetPasswordForEmail` 与 `resend` 使用 `redirectTo`（`js/features/auth_ui.js:224-227, 248-251`），需确保 `config.frontendBaseUrl` 来自受信环境变量与固定域。

## 体验影响（Wood/Water/Fire）
- 入口不一致：未挂载 Modal 导致 Landing 的登录入口不可用；分散入口影响路径认知（`index.html:98-103`）。
- 登录后跳转与“记住我”：逻辑合理但需稳定统一（`js/features/auth_ui.js:167-174, 107-111`）。
- 错误提示与回车行为：已完善（`js/features/auth_ui.js:189-207`），保持。
- Dashboard 守卫：工作正常（`js/dashboard_init.js:12-19`），与登出目标一致性需修复。

## 完全可执行的开发任务版本（带验收标准）
- [x] 生成架构审查报告（本文件）
- [x] 统一登出与守卫路由到 `login.html`
  - 修改点：`js/features/auth_ui.js:127-131` 将登出跳转改为 `login.html`
  - 验收：未登录访问 `dashboard.html` 与任何页面登出均指向 `login.html`
- [x] 生产禁用 Authorization 兜底（JWT-only）
  - 修改点：`js/services/supabaseClient.js:93-143` 增加 `import.meta.env.PROD` 守卫，禁用 `localStorage` 与 `anon key` 回退
  - 验收：生产构建下，`getAuthHeaders` 不再返回 `anon` 或 `localStorage` 来源；Edge Functions 在无 JWT 时返回 401
- [x] 统一 OAuth 登录入口重定向到 `/oauth-callback.html?action=login`
  - 修改点：`js/features/auth_ui.js:265-273`
  - 验收：Google 登录进入回调页进行登录映射；若存在绑定则切换至主账号，否则保持当前
- [x] 配置校验条件化
  - 修改点：`js/services/config.js:17-21`，将 `VITE_FRONTEND_BASE_URL` 设为条件必需，缺失时 `console.warn` 提示
  - 验收：未使用邮箱回跳/OAuth 时不阻断启动；使用相关功能时无错误提示
- [x] 清理重复 `modal_login.html`
  - 操作：删除 `components/modal_login.html`，保留 `public/components/modal_login.html`
  - 验收：`npm run lint:paths` 通过；所有引用均指向 `public/components/modal_login.html`
- [ ]（可选）实现 Landing Modal 挂载
  - 修改点：在 `js/main.js` 检测容器并注入 `/public/components/modal_login.html` 与 `/components/modal_signup.html`，执行 `initAuthUI('login')`
  - 验收：在 `index.html` 点击“登录 / 注册”弹出 Modal 并完成登录/注册流程；与独立页逻辑一致

## 参考代码定位（可快速导航）
- 会话守卫与跳转：`js/dashboard_init.js:12-19`
- 登出后跳转：`js/features/auth_ui.js:127-131`
- 登录页绑定：`js/features/auth_ui.js:134-208`
- 重发验证/忘记密码：`js/features/auth_ui.js:234-255, 210-232`
- Google 登录：`js/features/auth_ui.js:258-277`、`js/views/authView.js:20`
- 认证状态监听：`js/features/auth_ui.js:51-66`
- Supabase 客户端与认证头：`js/services/supabaseClient.js:13-35, 90-144`
- 配置校验：`js/services/config.js:6-22`
- Edge 函数邮箱确认校验：`supabase/functions/generate-digest/index.ts:29-32`

## 阴阳分析与推荐
- Yin（稳健）：先统一路由与禁用生产兜底，保证安全与一致性
- Yang（突破）：完善 Modal 挂载与 SDK ESM 引入，提升体验与可维护性
- 推荐：Yin 优先、Yang 次之，分两迭代完成

## 信心等级
- High：认证流、路由一致性、客户端封装与 Edge 校验判断
- Medium：是否启用 Landing Modal 属于产品选择；需结合团队偏好与 UX
- Medium：`VITE_FRONTEND_BASE_URL` 条件化校验策略依赖部署与 OAuth 使用频率
