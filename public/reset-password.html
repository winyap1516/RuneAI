<!DOCTYPE html>
<!-- 中文注释：重置密码页面（通过 Supabase 邮件链接进入） -->
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rune AI – 重置密码</title>
    <base href="./">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body class="font-display bg-background-light dark:bg-background-dark text-gray-900 dark:text-gray-100 min-h-screen flex items-center justify-center px-4 py-12">
    <div class="w-full max-w-[420px] bg-white dark:bg-[#1A1828] rounded-2xl shadow-card border border-gray-100 dark:border-gray-800 p-8">
      <div class="text-center mb-6">
        <h1 class="text-2xl font-bold">重置密码</h1>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">请输入新密码以完成重置</p>
      </div>
      <form id="resetForm" class="space-y-4" onsubmit="return false;">
        <div>
          <label class="block text-sm mb-1.5">新密码</label>
          <input id="newPwd" type="password" minlength="8" required class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800/50" placeholder="至少 8 位，包含字母与数字" />
        </div>
        <button id="btnResetPwd" type="button" class="w-full bg-primary text-white font-semibold py-2.5 px-4 rounded-lg">更新密码</button>
      </form>
      <p id="msg" class="mt-4 text-xs text-gray-600 dark:text-gray-400"></p>
    </div>
    <script type="module">
      // 中文注释：初始化 Supabase 客户端并在本页内实现“重置密码”逻辑（避免依赖不存在的外部模块）
      // 1) 从 ../src/js/services 相对路径加载封装的 Supabase 客户端，确保构建解析正常
      import { supabase } from '../src/js/services/supabaseClient.js';

      // 2) 获取 DOM 元素引用
      const form = document.getElementById('resetForm');
      const btn = document.getElementById('btnResetPwd');
      const msg = document.getElementById('msg');

      // 3) 强密码校验：≥8 字符，必须包含字母与数字
      function validateStrongPassword(pwd) {
        const s = String(pwd || '').trim();
        return s.length >= 8 && /[A-Za-z]/.test(s) && /\d/.test(s);
      }

      // 4) 执行更新密码逻辑：依赖 Supabase 邮件链接设置的临时 Session（type=recovery）
      async function updatePassword() {
        const newPwd = document.getElementById('newPwd')?.value || '';
        if (!validateStrongPassword(newPwd)) {
          msg.className = 'mt-4 text-xs text-red-600';
          msg.textContent = '密码不符合要求：至少 8 位，且包含字母与数字';
          return;
        }
        btn.disabled = true; btn.textContent = '更新中…';
        msg.className = 'mt-4 text-xs text-gray-600 dark:text-gray-400';
        msg.textContent = '';
        try {
          // 4.1 检查是否已存在恢复会话（点击邮件链接后，SDK 会自动从 URL 提取并建立临时 Session）
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) {
            throw new Error('恢复会话不存在或已过期，请重新申请重置链接');
          }

          // 4.2 使用恢复会话更新用户密码
          const { error } = await supabase.auth.updateUser({ password: newPwd });
          if (error) throw error;

          // 4.3 成功后建议注销恢复会话，提示用户前往登录页
          try { await supabase.auth.signOut(); } catch {}
          msg.className = 'mt-4 text-xs text-green-600';
          msg.textContent = '密码已更新，请使用邮箱/密码登录';
          const a = document.createElement('a'); a.href = 'login.html'; a.textContent = '前往登录'; a.className = 'block mt-2 text-primary hover:text-primary-hover';
          msg.appendChild(a);
        } catch (e) {
          msg.className = 'mt-4 text-xs text-red-600';
          msg.textContent = e?.message || '更新失败：请重新获取重置链接或联系客服';
        } finally {
          btn.disabled = false; btn.textContent = '更新密码';
        }
      }

      // 5) 事件绑定：点击按钮或表单提交均触发更新逻辑
      btn.addEventListener('click', (e) => { e.preventDefault(); updatePassword(); });
      form.addEventListener('submit', (e) => { e.preventDefault(); updatePassword(); });
    </script>
  </body>
</html>
